////1
// Jenkinsfile.pr → Build & Smoke rapide sur PR
pipeline {
    agent any
    triggers { pollSCM('H/5 * * * *') }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Setup Dependencies') {
            steps {
                parallel(
                    backend: { dir('server') { sh 'npm ci' } },
                    frontend: { dir('client') { sh 'npm ci' } }
                )
            }
        }

        stage('Build Docker Images') {
            steps { sh 'docker compose -f docker-compose.yml build --parallel' }
        }

        stage('Start Application') {
            steps {
                sh 'docker compose up -d mongodb server client'
                sh 'sleep 20' 
            }
        }

        stage('Smoke Tests (6+ tests)') {
            steps {
                parallel(
                    'Backend Smoke': { dir('server') { sh 'npm run test:smoke -- --coverage' } },
                    'Frontend Smoke': { dir('client') { sh 'npm run test:smoke -- --coverage' } }
                )
            }
        }

        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: '**/coverage/**, **/test-results/**', fingerprint: true, allowEmptyArchive: true
                junit testResults: '**/test-results/**/*.xml', allowEmptyResults: true
            }
        }

        stage('Cleanup') {
            steps { sh 'docker compose down -v --remove-orphans || true' }
        }
    }

    post {
        always { cleanWs() }
        failure { echo 'PR Smoke Test FAILED → Bloquer le merge !' }
    }
}