
////2
// Jenkinsfile.dev â†’ Build complet sur dev
pipeline {
    agent any
    environment {
        TAG = 'dev-latest'
        IMAGE_SERVER = 'jvygvu/devops-server'
        IMAGE_CLIENT = 'jvygvu/devops-client'
    }

    stages {
        stage('Checkout') { steps { checkout scm } }

        stage('Setup') {
            steps {
                parallel(
                    backend: { dir('server') { sh 'npm ci' } },
                    frontend: { dir('client') { sh 'npm ci' } }
                )
            }
        }

        stage('Build & Push Images') {
            steps {
                script {
                    docker.withRegistry('', 'dockerhub-cred') {
                        dir('server') { sh "docker build -t ${IMAGE_SERVER}:${TAG} ." ; sh "docker push ${IMAGE_SERVER}:${TAG}" }
                        dir('client') { sh "docker build -t ${IMAGE_CLIENT}:${TAG} ." ; sh "docker push ${IMAGE_CLIENT}:${TAG}" }
                    }
                }
            }
        }

        stage('Run & Smoke Test') {
            steps {
                sh 'docker compose up -d'
                sh 'sleep 20'
                parallel(
                    backend: { dir('server') { sh 'npm run test:smoke' } },
                    frontend: { dir('client') { sh 'npm run test:smoke' } }
                )
            }
        }

        stage('Archive') {
            steps { archiveArtifacts '**/coverage/**' }
        }

        stage('Cleanup') { steps { sh 'docker compose down -v' } }
    }
}
