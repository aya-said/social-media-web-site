////1
// Jenkinsfile.pr → Build & Smoke rapide sur PR
pipeline {
    agent any
    triggers { pollSCM('H/5 * * * *') }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Setup Dependencies') {
            steps {
                parallel(
                    backend: { dir('server') { sh 'npm ci' } },
                    frontend: { dir('client') { sh 'npm ci' } }
                )
            }
        }

        stage('Build Docker Images') {
            steps { sh 'docker compose -f docker-compose.yml build --parallel' }
        }

        stage('Start Application') {
            steps {
                sh 'docker compose up -d mongodb server client'
                sh 'sleep 20' 
            }
        }

        stage('Smoke Tests (6+ tests)') {
            steps {
                parallel(
                    'Backend Smoke': { dir('server') { sh 'npm run test:smoke -- --coverage' } },
                    'Frontend Smoke': { dir('client') { sh 'npm run test:smoke -- --coverage' } }
                )
            }
        }

        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: '**/coverage/**, **/test-results/**', fingerprint: true, allowEmptyArchive: true
                junit testResults: '**/test-results/**/*.xml', allowEmptyResults: true
            }
        }

        stage('Cleanup') {
            steps { sh 'docker compose down -v --remove-orphans || true' }
        }
    }

    post {
        always { cleanWs() }
        failure { echo 'PR Smoke Test FAILED → Bloquer le merge !' }
    }
}
////2
// Jenkinsfile.dev → Build complet sur dev
pipeline {
    agent any
    environment {
        TAG = 'dev-latest'
        IMAGE_SERVER = 'jvygvu/devops-server'
        IMAGE_CLIENT = 'jvygvu/devops-client'
    }

    stages {
        stage('Checkout') { steps { checkout scm } }

        stage('Setup') {
            steps {
                parallel(
                    backend: { dir('server') { sh 'npm ci' } },
                    frontend: { dir('client') { sh 'npm ci' } }
                )
            }
        }

        stage('Build & Push Images') {
            steps {
                script {
                    docker.withRegistry('', 'dockerhub-cred') {
                        dir('server') { sh "docker build -t ${IMAGE_SERVER}:${TAG} ." ; sh "docker push ${IMAGE_SERVER}:${TAG}" }
                        dir('client') { sh "docker build -t ${IMAGE_CLIENT}:${TAG} ." ; sh "docker push ${IMAGE_CLIENT}:${TAG}" }
                    }
                }
            }
        }

        stage('Run & Smoke Test') {
            steps {
                sh 'docker compose up -d'
                sh 'sleep 20'
                parallel(
                    backend: { dir('server') { sh 'npm run test:smoke' } },
                    frontend: { dir('client') { sh 'npm run test:smoke' } }
                )
            }
        }

        stage('Archive') {
            steps { archiveArtifacts '**/coverage/**' }
        }

        stage('Cleanup') { steps { sh 'docker compose down -v' } }
    }
}


///3
// Jenkinsfile.release → Versionnement officiel
pipeline {
    agent any
    environment {
        TAG = "${env.GIT_TAG_NAME}" 
        IMAGE_SERVER = 'jvygvu/devops-server'
        IMAGE_CLIENT = 'jvygvu/devops-client'
    }

    stages {
        stage('Checkout') { steps { checkout scm } }

        stage('Validate Tag') {
            when { tag "v*" }
            steps { echo "Release officielle : ${TAG}" }
        }

        stage('Build & Push Versionnée') {
            steps {
                script {
                    docker.withRegistry('', 'dockerhub-cred') {
                        sh "docker build -t ${IMAGE_SERVER}:${TAG} ./server"
                        sh "docker build -t ${IMAGE_CLIENT}:${TAG} ./client"
                        sh "docker push ${IMAGE_SERVER}:${TAG} && docker push ${IMAGE_SERVER}:latest"
                        sh "docker push ${IMAGE_CLIENT}:${TAG} && docker push ${IMAGE_CLIENT}:latest"
                    }
                }
            }
        }

        stage('Archive Release Artifacts') {
            steps {
                archiveArtifacts artifacts: 'docker-compose.yml, README.md, **/package.json'
                fingerprint 'docker-compose.yml'
            }
        }

        stage('Cleanup') { steps { sh 'docker system prune -f' } }
    }
}